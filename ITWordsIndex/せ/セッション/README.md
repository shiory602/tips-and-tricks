# セッション
関連：[クッキー](../../せ/クッキー)

## セッションの仕組み
Cookieに保存されたセッsyんIDとサーバーが持っ
1. ユーザがWebブラウザを使って、Webサーバにアクセスをする。
2. Webサーバ側はセッションIDを発行し、アクセスしてきたユーザと関連付ける。
3. 発行したセッションIDをアクセスしてきたWebブラウザのクッキーへ保存する。
4. 再び同じWebサーバにアクセスするときに、保存してあるクッキーを送信する。
5. Webサーバ側はクッキーを受取り、セッションIDを調べ、関連付けてあるユーザのデータを取り出す。ているセッションIDを比較して一致しているものがあったらユーザーがログイン済みと判断する。

### ログインまでのフロー
1. ユーザーにIDやパスワードなどでログインを求める。（ログインしていない状態のユーザーはセッションIDを持っていない）
2. 認証が成功したらサーバーはセッションIDを作成。生成するセッションIDは推測しにくい様に長いランダムなものを使用。
3. セッションIDとユーザー情報を紐付ける為、生成したセッションIDとユーザーIDをペアにしたデータをRedisなどのデータベースに保存。
4. 生成したセッションIDをCookieに保存。

### ポイント
- Cookieの中には情報は格納せず、セッションIDだけを格納することで盗まれても問題はなくなる。
- セッションIDを元に状態を復元するためのメモリは、Webサーバ上にあるから安全性も高い。
- Cookieに格納できる情報量の制限を気にしなくていい。

## クッキーとセッションの違い
| 特徴 | セッション | クッキー |
| --- | --- | --- |
| データの保存先 | サーバ内 | ユーザーのPC内（Webブラウザ毎） |
| データの保存容量 | ほぼ制限なし（最大はディスク容量まで） | 制限あり（１アプリ:4096Byte*20） |
| データの保存形式 | プログラムのデータ形式 | 文字列（テキストファイル） |
| 有効期限 | 固定（Webブラウザが閉じる、または設定ファイルの時間まで | 任意で設定 |
| セキュリティ面 | クッキーに比べ危険性は低い | 危険性が高い |
| データの利用 | 格納したらすぐに使える | 再リクエスト後から使える |

***

参考：[ウマロのゲームブログ](https://umaroidblog.com/webtechnology1),
[クッキーとセッションを利用しよう](https://kanda-it-school-kensyu.com/php-basic-contents/pb_ch11/pb_1103/),
[ふつうのWebサイトのセッションの仕組み](https://blog.kozakana.net/2017/08/about_web_session/)